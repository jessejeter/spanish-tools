<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a2e">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/png" href="icon-180.png">
<title>Spanish Flashcards</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #1a1a2e;
  --surface: #16213e;
  --card: #0f3460;
  --card-back: #1a1a40;
  --text: #e4e4e4;
  --text-dim: #8888aa;
  --accent: #e94560;
  --green: #4ecca3;
  --yellow: #f0c040;
  --red: #e94560;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

/* Loading / Error states */
#loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  gap: 16px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--surface);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

#error {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  gap: 16px;
  padding: 24px;
  text-align: center;
}

#error button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
}

/* App layout */
#app {
  display: none;
  flex-direction: column;
  flex: 1;
  max-width: 500px;
  width: 100%;
  margin: 0 auto;
  padding: 16px;
  gap: 16px;
}

/* Top bar */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  color: var(--text-dim);
}

.top-bar .count { font-weight: 600; color: var(--text); }

.progress-bar {
  height: 3px;
  background: var(--surface);
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--green);
  transition: width 0.3s ease;
}

/* Card */
.card-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  perspective: 1000px;
  cursor: pointer;
  min-height: 0;
}

.card {
  width: 100%;
  max-height: 100%;
  min-height: 250px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.4s ease;
}

.card.flipped { transform: rotateY(180deg); }

.card-face {
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px 24px;
}

.card-front {
  background: var(--card);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.card-back {
  background: var(--card-back);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  transform: rotateY(180deg);
  justify-content: flex-start;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.card-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-dim);
  margin-bottom: 16px;
}

.card-word {
  font-size: clamp(28px, 8vw, 48px);
  font-weight: 700;
  text-align: center;
  line-height: 1.2;
}

.card-translation {
  font-size: clamp(24px, 6vw, 36px);
  font-weight: 700;
  text-align: center;
  margin-bottom: 12px;
  width: 100%;
}

.card-pos {
  font-size: 14px;
  color: var(--green);
  margin-bottom: 16px;
  font-style: italic;
}

.card-other {
  font-size: 14px;
  line-height: 1.5;
  color: var(--green);
  text-align: left;
  width: 100%;
  white-space: pre-wrap;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  display: none;
}

.card-other .other-title {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  margin-bottom: 6px;
}

.card-analysis {
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-dim);
  text-align: left;
  width: 100%;
  white-space: pre-wrap;
}

.tap-hint {
  font-size: 12px;
  color: var(--text-dim);
  margin-top: 24px;
  opacity: 0.6;
}

/* Grade buttons */
.grade-buttons {
  display: flex;
  gap: 12px;
  padding-bottom: env(safe-area-inset-bottom, 8px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.grade-buttons.visible {
  opacity: 1;
  pointer-events: auto;
}

.grade-btn {
  flex: 1;
  padding: 16px 8px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  transition: transform 0.1s ease, opacity 0.1s ease;
}

.grade-btn:active { transform: scale(0.95); opacity: 0.8; }

.grade-btn .label { font-size: 12px; opacity: 0.8; }

.btn-again { background: var(--red); }
.btn-hard { background: #7a6c2a; }
.btn-easy { background: #2a7a5a; }

/* Done screen */
#done {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  gap: 16px;
  padding: 24px;
  text-align: center;
}

#done h2 { font-size: 28px; margin-bottom: 8px; }
#done p { color: var(--text-dim); font-size: 16px; }

#done button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
}

/* Stats bar on done screen */
.stats {
  display: flex;
  gap: 24px;
  margin-top: 8px;
}

.stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat-num {
  font-size: 28px;
  font-weight: 700;
}

.stat-label {
  font-size: 12px;
  color: var(--text-dim);
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <p>Loading vocabulary...</p>
</div>

<!-- Error -->
<div id="error">
  <p id="error-msg">Failed to load vocabulary.</p>
  <button onclick="location.reload()">Retry</button>
</div>

<!-- App -->
<div id="app">
  <div class="top-bar">
    <span id="counter" class="count"></span>
    <span id="due-label"></span>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="progress"></div>
  </div>

  <div class="card-container" id="card-container">
    <div class="card" id="card">
      <div class="card-face card-front">
        <div class="card-label" id="front-label"></div>
        <div class="card-word" id="front-word"></div>
        <div class="tap-hint">tap to flip</div>
      </div>
      <div class="card-face card-back">
        <div class="card-label" id="back-label"></div>
        <div class="card-translation" id="back-word"></div>
        <div class="card-pos" id="back-pos"></div>
        <div class="card-other" id="back-other"></div>
        <div class="card-analysis" id="back-analysis"></div>
      </div>
    </div>
  </div>

  <div class="grade-buttons" id="grade-buttons">
    <button class="grade-btn btn-again" onclick="grade('again')">
      Again
      <span class="label">&lt;1d</span>
    </button>
    <button class="grade-btn btn-hard" onclick="grade('hard')">
      Hard
      <span class="label" id="hard-interval"></span>
    </button>
    <button class="grade-btn btn-easy" onclick="grade('easy')">
      Easy
      <span class="label" id="easy-interval"></span>
    </button>
  </div>
</div>

<!-- Done -->
<div id="done">
  <h2>All done!</h2>
  <p>You've reviewed all cards for today.</p>
  <div class="stats">
    <div class="stat">
      <span class="stat-num" id="stat-reviewed">0</span>
      <span class="stat-label">Reviewed</span>
    </div>
    <div class="stat">
      <span class="stat-num" id="stat-new">0</span>
      <span class="stat-label">New</span>
    </div>
  </div>
  <button onclick="location.reload()">Start New Session</button>
  <button onclick="practiceAll()" style="background:#16213e; margin-top:0;">Practice All Cards</button>
</div>

<script>
const SPREADSHEET_ID = '14oqOzF2MXMDvhp8XbZo1fa3yFHTW3anVgfFrHvK4tNc';
const SHEET1_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1`;
const SHEET2_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet2`;
const STORAGE_KEY = 'spanish-flashcards-srs';
const NEW_CARDS_PER_SESSION = 10;

let allCards = [];
let sessionQueue = [];
let currentIndex = 0;
let currentCard = null;
let isFlipped = false;
let sessionStats = { reviewed: 0, newCards: 0 };

// ---- Google Visualization JSON Parsing ----
function parseGvizJson(text) {
  // Response is: /*O_o*/\ngoogle.visualization.Query.setResponse({...});
  const match = text.match(/google\.visualization\.Query\.setResponse\(({.*})\)/s);
  if (!match) throw new Error('Invalid response from Google Sheets');
  const data = JSON.parse(match[1]);
  if (data.status === 'error') {
    throw new Error(data.errors?.map(e => e.message).join(', ') || 'Sheet error');
  }
  const table = data.table;
  // Convert to rows of string arrays (skip header row)
  return table.rows.map(row =>
    row.c.map(cell => (cell && cell.v != null) ? String(cell.v) : '')
  );
}

// ---- Data Loading ----
async function fetchSheet(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return parseGvizJson(await res.text());
}

async function loadData() {
  try {
    const [s1, s2] = await Promise.all([
      fetchSheet(SHEET1_URL),
      fetchSheet(SHEET2_URL)
    ]);

    const cards = [];
    for (let i = 0; i < s1.length && i < s2.length; i++) {
      const reviewed = (s2[i][2] || '').toUpperCase() === 'TRUE';
      if (!reviewed) continue;

      cards.push({
        spanish: s1[i][1] || '',
        english: s1[i][2] || '',
        pos: s1[i][3] || '',
        analysis: s2[i][1] || '',
        otherTranslations: s2[i][4] || '',
      });
    }

    if (cards.length === 0) {
      throw new Error('No reviewed words found. Mark words as reviewed in Sheet2 column C.');
    }

    allCards = cards;
    buildSession();
    showApp();
  } catch (err) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'flex';
    document.getElementById('error-msg').textContent = err.message;
  }
}

// ---- SRS Storage ----
function getSRS() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
  } catch { return {}; }
}

function saveSRS(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function getCardSRS(word) {
  const srs = getSRS();
  return srs[word] || null;
}

function updateCardSRS(word, rating) {
  const srs = getSRS();
  const now = todayStr();
  let card = srs[word] || { interval: 0, easeFactor: 2.5, nextReview: now };

  if (rating === 'again') {
    card.interval = 1;
    card.easeFactor = Math.max(1.3, card.easeFactor - 0.2);
  } else if (rating === 'hard') {
    card.interval = Math.max(1, Math.round((card.interval || 1) * 1.2));
    card.easeFactor = Math.max(1.3, card.easeFactor - 0.15);
  } else { // easy
    card.interval = Math.max(1, Math.round((card.interval || 1) * card.easeFactor));
    card.easeFactor += 0.15;
  }

  const next = new Date();
  next.setDate(next.getDate() + card.interval);
  card.nextReview = dateStr(next);
  card.lastReview = now;

  srs[word] = card;
  saveSRS(srs);
  return card;
}

// ---- Date Helpers ----
function todayStr() {
  return dateStr(new Date());
}

function dateStr(d) {
  return d.toISOString().split('T')[0];
}

function isDue(cardSRS) {
  if (!cardSRS) return false;
  return cardSRS.nextReview <= todayStr();
}

// ---- Session Building ----
function buildSession() {
  const srs = getSRS();
  const due = [];
  const newCards = [];

  for (const card of allCards) {
    const data = srs[card.spanish];
    if (!data) {
      newCards.push(card);
    } else if (isDue(data)) {
      due.push(card);
    }
  }

  // Shuffle due cards
  shuffle(due);

  // Take a batch of new cards
  shuffle(newCards);
  const newBatch = newCards.slice(0, NEW_CARDS_PER_SESSION);

  // Due cards first, then new
  sessionQueue = [...due, ...newBatch];
  currentIndex = 0;
  sessionStats = { reviewed: 0, newCards: 0 };
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// ---- UI ----
function showApp() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'flex';

  if (sessionQueue.length === 0) {
    showDone();
    return;
  }

  showCard();
}

function showCard() {
  if (currentIndex >= sessionQueue.length) {
    showDone();
    return;
  }

  currentCard = sessionQueue[currentIndex];
  isFlipped = false;

  const card = document.getElementById('card');
  card.classList.remove('flipped');
  document.getElementById('grade-buttons').classList.remove('visible');

  // Random direction
  const showSpanish = Math.random() < 0.5;

  if (showSpanish) {
    document.getElementById('front-label').textContent = 'Spanish';
    document.getElementById('front-word').textContent = currentCard.spanish;
    document.getElementById('back-label').textContent = 'English';
    document.getElementById('back-word').textContent = currentCard.english;
  } else {
    document.getElementById('front-label').textContent = 'English';
    document.getElementById('front-word').textContent = currentCard.english;
    document.getElementById('back-label').textContent = 'Spanish';
    document.getElementById('back-word').textContent = currentCard.spanish;
  }

  document.getElementById('back-pos').textContent = currentCard.pos;

  // Show other translations only for Englishâ†’Spanish cards
  const otherEl = document.getElementById('back-other');
  if (!showSpanish && currentCard.otherTranslations) {
    otherEl.style.display = 'block';
    otherEl.innerHTML = '<div class="other-title">Other Translations</div>' +
      currentCard.otherTranslations;
  } else {
    otherEl.style.display = 'none';
  }

  document.getElementById('back-analysis').textContent = currentCard.analysis;

  // Update counter
  const remaining = sessionQueue.length - currentIndex;
  document.getElementById('counter').textContent =
    `${currentIndex + 1} of ${sessionQueue.length}`;
  document.getElementById('due-label').textContent =
    `${remaining} remaining`;

  // Progress bar
  const pct = (currentIndex / sessionQueue.length) * 100;
  document.getElementById('progress').style.width = pct + '%';

  // Update interval hints
  const srs = getCardSRS(currentCard.spanish);
  const interval = srs ? srs.interval || 1 : 1;
  const ef = srs ? srs.easeFactor || 2.5 : 2.5;
  document.getElementById('hard-interval').textContent = formatInterval(Math.max(1, Math.round(interval * 1.2)));
  document.getElementById('easy-interval').textContent = formatInterval(Math.max(1, Math.round(interval * ef)));
}

function formatInterval(days) {
  if (days < 30) return days + 'd';
  if (days < 365) return Math.round(days / 30) + 'mo';
  return (days / 365).toFixed(1) + 'y';
}

function flipCard() {
  if (isFlipped) return;
  isFlipped = true;
  document.getElementById('card').classList.add('flipped');
  document.getElementById('grade-buttons').classList.add('visible');
}

function grade(rating) {
  if (!currentCard) return;

  const srs = getSRS();
  const isNew = !srs[currentCard.spanish];
  if (isNew) sessionStats.newCards++;
  sessionStats.reviewed++;

  updateCardSRS(currentCard.spanish, rating);

  // If "again", re-add to end of queue
  if (rating === 'again') {
    sessionQueue.push(currentCard);
  }

  currentIndex++;
  showCard();
}

function showDone() {
  document.getElementById('app').style.display = 'none';
  document.getElementById('done').style.display = 'flex';
  document.getElementById('stat-reviewed').textContent = sessionStats.reviewed;
  document.getElementById('stat-new').textContent = sessionStats.newCards;

  // Progress bar full
  document.getElementById('progress').style.width = '100%';
}

function practiceAll() {
  sessionQueue = [...allCards];
  shuffle(sessionQueue);
  currentIndex = 0;
  sessionStats = { reviewed: 0, newCards: 0 };
  document.getElementById('done').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  showCard();
}

// ---- Event Listeners ----
document.getElementById('card-container').addEventListener('click', (e) => {
  // Don't flip if scrolling analysis text
  if (e.target.closest('.card-back') && isFlipped) return;
  flipCard();
});

// Keyboard support
document.addEventListener('keydown', (e) => {
  if (e.key === ' ' || e.key === 'Enter') {
    e.preventDefault();
    if (!isFlipped) flipCard();
  } else if (isFlipped) {
    if (e.key === '1') grade('again');
    else if (e.key === '2') grade('hard');
    else if (e.key === '3') grade('easy');
  }
});

// ---- Init ----
loadData();
</script>
</body>
</html>
